name: Data Quality Monitor

on:
  schedule:
    # Run Mon-Sat at 01:30 UTC (after NAV update completes at ~01:00 UTC)
    # Saturday processes Friday's trading day
    - cron: '30 1 * * 1-6'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to check'
        required: false
        default: '7'
      email:
        description: 'Override email recipient (uses ALERT_EMAIL secret if not provided)'
        required: false

jobs:
  monitor:
    name: Run Data Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Data Quality Monitor
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          EODHD_API_KEY: ${{ secrets.EODHD_API_KEY }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ github.event.inputs.email || secrets.ALERT_EMAIL }}
        run: |
          python scripts/data_quality_monitor.py \
            --days ${{ github.event.inputs.days || '7' }} \
            --email "$ALERT_EMAIL" \
            --auto-repair

      - name: Upload results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-quality-report
          path: |
            *.json
          retention-days: 30

  notify-on-failure:
    name: Notify on Workflow Failure
    needs: monitor
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Send failure notification
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          # Use Python to send email about workflow failure
          python3 << 'EOF'
          import os
          import smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart

          smtp_server = os.getenv("SMTP_SERVER", "smtp.gmail.com")
          smtp_port = int(os.getenv("SMTP_PORT", "587"))
          smtp_user = os.getenv("SMTP_USER")
          smtp_password = os.getenv("SMTP_PASSWORD")
          recipient = os.getenv("ALERT_EMAIL")

          if not all([smtp_user, smtp_password, recipient]):
              print("Email not configured, skipping notification")
              exit(0)

          msg = MIMEMultipart()
          msg["Subject"] = "ðŸš¨ ASM Data Quality Monitor - WORKFLOW FAILED"
          msg["From"] = smtp_user
          msg["To"] = recipient

          body = f"""
          The ASM Data Quality Monitor workflow has FAILED.

          This could indicate:
          1. Database connection issues
          2. Missing dependencies
          3. Script errors

          Please check the GitHub Actions logs:
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Timestamp: {os.popen('date').read().strip()}
          """

          msg.attach(MIMEText(body, "plain"))

          try:
              with smtplib.SMTP(smtp_server, smtp_port) as server:
                  server.starttls()
                  server.login(smtp_user, smtp_password)
                  server.sendmail(smtp_user, recipient, msg.as_string())
              print(f"Failure notification sent to {recipient}")
          except Exception as e:
              print(f"Failed to send notification: {e}")
          EOF
